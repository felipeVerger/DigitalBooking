stages:
  - triggers
  - deploy
      
trigger_front:
  stage: triggers
  trigger:
    include: front/.gitlab-ci.yml
  rules:
    - if: $CI_COMMIT_BRANCH == '107-automatizar-deploy'
    #- if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "merge_request_event"'


trigger_back:
  stage: triggers
  trigger:
    include: back/.gitlab-ci.yml
  rules:
    - if: $CI_COMMIT_BRANCH == '107-automatizar-deploy'
    #- if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "merge_request_event"'
    
trigger_infra:
  stage: triggers
  trigger:
    include: infraestructura/.gitlab-ci.yml
  rules:
    - if: $CI_COMMIT_BRANCH == '107-automatizar-deploy'
    #- if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "merge_request_event"' 

deploy:
  stage: deploy
  needs: [ trigger_back, trigger_front ]
  image: alpine
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh )' 
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/0821-g10.pem
    - chmod 700 0821-g10.pem
    - echo "$PROD_SERVER_IP" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  script:
    - ssh -i 0821-g10.pem ubuntu@$PROD_SERVER_IP
    - ls -la
    - cd ansible/
    - ansible-playbook rundocker-back.yml -i hosts
    - ansible-playbook rundocker-front.yml -i hosts 
  rules:
    - if: $CI_COMMIT_BRANCH == '107-automatizar-deploy'